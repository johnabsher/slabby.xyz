name: GCS Upload
run-name: ${{ github.actor }} is uploading to GCS ðŸš€
on:
    push:
      branches:
        - main
    workflow_dispatch:

# Allow this job to clone the repo and create a page deployment
permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout your repository using git
            uses: actions/checkout@v4
          - name: Install, build, and upload your site
            uses: withastro/action@v2
            with:
              path: astro-v1/ # The root location of your Astro project inside the repository. (optional)
              # node-version: 20 # The specific version of Node that should be used to build your site. Defaults to 20. (optional)
              # package-manager: pnpm@latest # The Node package manager that should be used to install dependencies and build your site. Automatically detected based on your lockfile. (optional)

    upload-to-gcs:
      permissions:
        contents: 'read'
        id-token: 'write'

      runs-on: 'ubuntu-latest'
  
      steps:
      - id: 'checkout'
        uses: 'actions/checkout@v4'
  
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCS_CREDENTIALS }}'
          # project_id: 'slabby-xyz-site'
          # workload_identity_provider: 'projects/396362042427/locations/global/workloadIdentityPools/github/providers/slabby-xyz'
            # 'projects/396362042427/locations/global/workloadIdentityPools/github'
          # projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'
          # service_account: 'my-service-account@my-project.iam.gserviceaccount.com'
  
      - id: 'upload-folder'
        uses: 'google-github-actions/upload-cloud-storage@v2'
        with:
          path: 'astro-v1/dist'
          destination: 'slabby.xyz'
          parent: false